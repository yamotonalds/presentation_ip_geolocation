% IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰åœ°åŸŸã‚’æ±‚ã‚ã¦ã¿ãŸ
% yamotonalds
% 2016-11-28
# 

## å…ˆé€±é‡‘æ›œã®åˆå¾Œâ€¦

## é‹å–¶ã®æŸTã•ã‚“

. . .

<img src="images/t_san.png" width="50px" height="50px" />ã€Œå¤§é‡ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰å¤§ã¾ã‹ãªåœ°åŸŸã‚’èª¿ã¹ã‚‹æ–¹æ³•ã£ã¦ç„¡ã„ã§ã™ã‹ã­ï¼Ÿã€

## 

ğŸ¼ã€Œã¡ã‚‡ã£ã¨èª¿ã¹ã¦ã¿ã¾ã™^^ã€

##

ğŸ¼ï¼ˆã¨ã¯è¨€ã£ãŸã‚‚ã®ã®â€¦ï¼‰

##

![](images/siranai.jpeg)

## ã“ã®æ™‚ç‚¹ã§ğŸ¼ãŒçŸ¥ã£ã¦ã„ãŸã“ã¨

- IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰å¤§ã¾ã‹ãªåœ°åŸŸã‚’èª¿ã¹ã‚‹æ–¹æ³•ã¯å­˜åœ¨ã™ã‚‹
    - åŸç†ã¯çŸ¥ã‚‰ãªã„
- æ­£ç¢ºãªä½æ‰€ã‚„å€‹äººã‚’ç‰¹å®šã™ã‚‹ã“ã¨ã¯ã§ããªã„
    - ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«è¨˜éŒ²ã¯ã‚ã‚‹ã¯ãšãªã®ã§è­¦å¯Ÿãªã‚‰èª¿ã¹ã‚‰ã‚Œã‚‹ ğŸ‘®

## èª¿ã¹ã¦ã‚ã‹ã£ãŸã“ã¨

åˆ†å ±çª“ã§ã®æƒ…å ±æä¾›ã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ m(_ _)m

- IPã‹ã‚‰ãƒ›ã‚¹ãƒˆåã‚’å¼•ã„ãŸã‚Štracerouteã§åˆ†ã‹ã‚‹å ´åˆãŒã‚ã‚‹
    - OCNã®ä¾‹ p****-ipbfp****osakakita.osaka.ocn.ne.jp.
        - å¤§é˜ªåºœå¤§é˜ªåŒ—ï¼Ÿ
    - ã·ã‚‰ã‚‰ã®ä¾‹ i***-***-***-***.s41.a011.ap.plala.or.jp.
        - ã€Œa011ã€ã¯åŸ¼ç‰çœŒ
        - ã€Œs41ã€ã¯ãƒ•ãƒ¬ãƒƒãƒ„ãƒã‚¯ã‚¹ãƒˆãƒ•ã‚¡ãƒŸãƒªãƒ¼
    - [http://wiki.tomocha.net/network_ISP_areasearch.html](http://wiki.tomocha.net/network_ISP_areasearch.html)

## èª¿ã¹ã¦ã‚ã‹ã£ãŸã“ã¨

- IPã‹ã‚‰åœ°åŸŸç­‰ã®æƒ…å ±ã‚’èª¿ã¹ã‚‹Webã‚µãƒ¼ãƒ“ã‚¹ã¯ãŸãã•ã‚“ã‚ã‚‹
    - ç„¡æ–™ã§å¤§é‡ã®IPã‚’å‡¦ç†ã§ãã‚‹ã‚‚ã®ã¯ï¼ˆã±ã£ã¨è¦‹ï¼‰ç„¡ã•ãã†
- ã‚±ãƒ¼ã‚¿ã‚¤ã®IPã¯åœ°åŸŸæƒ…å ±ã‚ã‹ã‚‰ãªã•ãã†ï¼Ÿ
    - ã‚­ãƒ£ãƒªã‚¢ã”ã¨ã«ä½¿ç”¨ã™ã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹å¸¯åŸŸã¯å…¬é–‹ã•ã‚Œã¦ã„ã‚‹
    - ä¸Šè¨˜ã®Webã‚µãƒ¼ãƒ“ã‚¹ã«ã‚¹ãƒãƒ›ã®IPã‚’å…¥ã‚ŒãŸã‚‰åˆ¤å®šã¯ã€Œæ±äº¬ã€ã ã£ãŸ
- ç„¡æ–™ã®IP Geolocation databaseãŒé…å¸ƒã•ã‚Œã¦ã„ã‚‹
    - [MaxMind GeoLite2](http://dev.maxmind.com/ja/geolite2/)

## 

- å¤§é‡ï¼ˆæ•°ä¸‡ä»¶ï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’
- ç„¡æ–™ã§
- ãã‚Œãªã‚Šã«çŸ­æ™‚é–“ã§
- ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚’å¤–éƒ¨ã«å‡ºã—ãŸããªã„ï¼‰

. . .

GeoLite2ã‚’è©¦ã—ã¦ã¿ã‚ˆã†Ù©( 'Ï‰' )Ùˆ

# GeoLite2

## MaxMindç¤¾ãŒé…å¸ƒã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿

>GeoLite2 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯ã€ç„¡å„Ÿã® IP åœ°ç†ä½ç½®æƒ…å ±ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã€MaxMind ã® GeoIP2 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨åŒç­‰ã§ã¯ã‚ã‚Šã¾ã™ãŒã€ç²¾åº¦ã®ç‚¹ã§å¤šå°‘åŠ£ã‚Šã¾ã™ã€‚GeoLite2 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯ã€æ¯æœˆã®ç¬¬ä¸€ç«æ›œæ—¥ã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã•ã‚Œã¾ã™ã€‚

ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã¯ã€Œã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ãƒ»ã‚³ãƒ¢ãƒ³ã‚º è¡¨ç¤º-ç¶™æ‰¿ 3.0 éç§»æ¤ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã€

## é…å¸ƒã•ã‚Œã¦ã„ã‚‹ã‚‚ã®

[http://dev.maxmind.com/ja/geolite2/](http://dev.maxmind.com/ja/geolite2/)

- GeoLite2-City-Locations-ja.csv
    - åœ°åŸŸãƒã‚¹ã‚¿
    - å›½åã€çœŒåã€å¸‚åç­‰
- GeoLite2-City-Blocks-IPv4.csv
    - IPã‚¢ãƒ‰ãƒ¬ã‚¹å¸¯åŸŸã¨åœ°åŸŸIDã®ç´ä»˜ã‘


## GeoLite2-City-Locations-ja.csv

![](images/geolite2-loc.png)

## GeoLite2-City-Blocks-IPv4.csv

![](images/geolite2-block.png)


# å®Ÿè£…

## ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™

GeoLite2ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾ä½¿ã†ã“ã¨ã‚‚ã§ãã‚‹ã€‚

ã§ã‚‚ã¾ã‚ç°¡å˜ã«ã‚µã‚¯ãƒƒã¨ä½¿ã„ãŸã„ã ã‘ãªã®ã§ã€æ—¥æœ¬ã®ãƒ‡ãƒ¼ã‚¿ã ã‘ã§ã„ã„ã—æ­£è¦åŒ–ã‚‚ä¸è¦ã€‚

## 

```sh
head -1 ./GeoLite2-City-Locations-ja.csv > loc_db_only_jp.csv
grep "æ—¥æœ¬" ./GeoLite2-City-Locations-ja.csv >> loc_db_only_jp.csv
q -H -d',' "select ip_rule.network,\
  loc_jp.subdivision_1_name || loc_jp.city_name \
  from ./GeoLite2-City-Blocks-IPv4.csv ip_rule \
  inner join ./loc_db_only_jp.csv loc_jp \
  on ip_rule.geoname_id = loc_jp.geoname_id" > ip_block_jp.csv
```

## 

![](images/jp_only.png)

## ã‚³ãƒ¼ãƒ‰

```rb
require 'csv'
require 'ipaddr'
require 'pathname'

ip_file = Pathname.new(ARGV[0])
ip_block_list = CSV.read('ip_block_jp.csv')
mapping = ip_block_list.map { |(ip_block, loc)| [IPAddr.new(ip_block), loc] }
mapping.sort_by! { |(ip_block, _)| ip_block.to_s.split('/', 2).last.to_i * -1 }

filename = "#{ip_file.dirname}/#{ip_file.basename('.*')}_with_location#{ip_file.extname}"
CSV.open(filename, "wb") do |csv|
  CSV.foreach(ip_file) do |(ip)|
    csv << [ip, mapping.find { |(ip_block, loc)| ip_block.include?(ip) }&.last]
  end
end
```

## çµæœ

![](images/result.png)


## ã—ã‹ã—â€¦

. . .

ã‚ã£ã¡ã‚ƒé…ã„

![](images/osoi.jpg)

##

IPã‚¢ãƒ‰ãƒ¬ã‚¹100ä»¶ã®å‡¦ç†ã«20ç§’ãã‚‰ã„ã€‚
ãƒ–ãƒ©ã‚¦ã‚¶è‡ªå‹•æ“ä½œã‚ˆã‚Šã¯é€Ÿã„ã‹ã‚‚ã ã‘ã©ã€‚
æ•°ä¸‡ä»¶ï¼ˆæ•°åƒç§’ï¼‰ã¨ã‹å¾…ã¡ãã‚Œãªã„ã€‚

â€» å®Ÿè¡Œã¯MBP

## ã©ã“ãŒé…ã„ã®ã‹

ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã—ã¦ç¢ºèªã€‚

. . .

```rb
CSV.foreach(ip_file) do |(ip)|
  csv << [ip, mapping.find { |(ip_block, loc)| ip_block.include?(ip) }&.last]
end
```

mappingãŒç´„6ä¸‡ä»¶ã€‚

æ—¥æœ¬ã®ãƒ‡ãƒ¼ã‚¿ã ã‘ã«ã—ãŸã‘ã©ã¾ã å…¨éƒ¨åˆ¤å®šã•ã›ã¦ãŸã‚‰é…ã„ã€‚

## é«˜é€ŸåŒ–

. . .

`123.123.123.0/24` ã¨ã‹ã®ç¯„å›²ã‚’å…¨éƒ¨å€‹åˆ¥IPã«å±•é–‹ã—ã¦BigQueryã«å…¥ã‚Œ(ry

. . .

![](images/bq_nou.png)

## é«˜é€ŸåŒ–

IP Blockã®ãƒã‚¹ã‚¯å€¤ãŒ8ã‚ˆã‚Šå°ã•ã„ãƒ‡ãƒ¼ã‚¿ã¯ç„¡ã„ã€‚

â†’IPã‚¢ãƒ‰ãƒ¬ã‚¹ã®æœ€åˆã®8bitã¯ãƒã‚¹ã‚¯ã—ã¦ã‚‚å¤‰ã‚ã‚‰ãªã„ã€‚

â†’IPãŒ `123.x.y.z` ãªã‚‰ `123.a.b.c/m` ã®ã‚‚ã®ã ã‘è¦‹ã‚Œã°OKã€‚

. . .

æ•°ä¸‡ä»¶ã®åˆ¤å®š â†’ æ•°ç™¾ã€œæ•°åƒä»¶ã®åˆ¤å®š


## æ”¹å–„å¾Œã®ã‚³ãƒ¼ãƒ‰ï¼ˆä¸€éƒ¨ï¼‰

```rb
def first_byte(ip)
  ip.to_s.split('.', 2).first
end

mapping = mapping.group_by { |(ip_block, loc)| first_byte(ip_block.to_s) }

...

CSV.foreach(ip_file) do |(ip)|
  csv << [ip, mapping[first_byte(ip)].find { |(ip_block, loc)| ip_block.include?(ip) }&.last]
end

...
```

## å‡¦ç†æ™‚é–“ã®æ”¹å–„

åˆ¤å®šéƒ¨åˆ†: 20ç§’ â†’ 0.3ç§’

å‰å‡¦ç†å«ã‚ã¦ã‚‚ä»¥å‰ã®1/10ä»¥ä¸‹ã®æ™‚é–“ã§å®Œäº†ã€‚
ï¼ˆmappingã®csvèª­ã¿è¾¼ã¿ã«1ç§’ãã‚‰ã„ã‹ã‹ã‚‹ã€‚ï¼‰

. . .

![](images/hayai.jpg)

# 

## æ„Ÿæƒ³

- MaxMindç¤¾ã•ã‚“ã€ç„¡æ–™é…å¸ƒã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™
- 20è¡Œãã‚‰ã„ã§æ›¸ã‘ã‚‹ã®è¶…æ¥½ã§ã™ã­ ğŸ¼
- ã‚‚ã£ã¨é€Ÿãã§ãã‚‹ã ã‚ã†ã‘ã©ä»Šå›ã¯ã“ã‚Œã§ååˆ†ã‹ãª(Â´ãƒ»Ï‰ãƒ»ï½€)

## ã¡ãªã¿ã«â€¦

ä¾é ¼è‡ªä½“ã¯ã‚±ãƒ¼ã‚¿ã‚¤ã®IPãŒåˆ¤å®šã§ããªã„ã®ã§æµã‚Œã¾ã—ãŸã€‚

ï¼ˆGPSæƒ…å ±ä½¿ã†ã‚‰ã—ã„ã§ã™ã€‚ï¼‰




